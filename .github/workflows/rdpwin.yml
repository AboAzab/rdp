name: RDP with Cloudflare Tunnel

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Download Cloudflared
        run: |
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

      - name: Setup RDP
        run: |
          net user kame23 S5316875844@a /add
          net localgroup administrators kame23 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-Service -Name "TermService" -StartupType Automatic
          Start-Service -Name "TermService"
          Start-Sleep -Seconds 10

      - name: Enable Multiple Sessions & Disconnect Console
        run: |
          # Enable multiple sessions
          New-Item -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name 'fSingleSessionPerUser' -Value 0 -Type DWord -Force
          
          # Restart service
          Restart-Service -Name "TermService" -Force
          Start-Sleep -Seconds 5
          
          # Disconnect current console session
          try {
            $sessions = query user
            $consoleSession = ($sessions | Select-String 'console') -split '\s+' 
            $sessionId = $consoleSession[2]
            Write-Host "Disconnecting console session ID: $sessionId"
            tsdiscon $sessionId
            Start-Sleep -Seconds 3
          } catch {
            Write-Host "Could not disconnect console: $($_.Exception.Message)"
          }

      - name: Create tunnel config
        run: |
          @"
          tunnel: 64f30b0b-64cf-40fd-88d5-ac86509c0aed
          
          ingress:
            - hostname: rdp.aboodi24.com
              service: rdp://localhost:3389
            - service: http_status:404
          "@ | Out-File -FilePath config.yml -Encoding UTF8

      - name: Start Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel", "--config", "config.yml", "run", "--token", "$env:TUNNEL_TOKEN" -NoNewWindow -RedirectStandardOutput tunnel.log
          
          Start-Sleep -Seconds 20
          
          Write-Host "=========================================="
          Write-Host "Tunnel: rdp.aboodi24.com"
          Write-Host "Username: kame23"
          Write-Host "Password: S5316875844@a"
          Write-Host "=========================================="

      - name: Keep alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active: $(Get-Date)"
          }
