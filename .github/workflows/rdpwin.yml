name: RDP with Bore

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Download Bore
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          Move-Item .\bore.exe .\bore.exe -Force

      - name: Setup RDP
        run: |
          net user kame23 S5316875844@a /add
          net localgroup administrators kame23 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-Service -Name "TermService" -StartupType Automatic
          Start-Service -Name "TermService"
          Start-Sleep -Seconds 10

      - name: Start Bore Tunnel
        run: |
          Start-Process -FilePath ".\bore.exe" -ArgumentList "local", "3389", "--to", "bore.pub" -NoNewWindow -RedirectStandardOutput bore.log -RedirectStandardError bore_error.log
          
          Start-Sleep -Seconds 15
          
          # Get the output
          if (Test-Path bore.log) {
            $output = Get-Content bore.log -Raw
            Write-Host $output
            
            # Try to extract port
            if ($output -match "bore\.pub:(\d+)") {
              $port = $matches[1]
              Write-Host "=========================================="
              Write-Host "CONNECT TO: bore.pub:$port"
              Write-Host "Username: kame23"
              Write-Host "Password: S5316875844@a"
              Write-Host "=========================================="
            }
          }
          
          if (Test-Path bore_error.log) {
            Write-Host "Errors:"
            Get-Content bore_error.log
          }

      - name: Keep alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Session active: $(Get-Date)"
          }
