name: RDP with LocalXpose

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Download LocalXpose
        run: |
          Invoke-WebRequest https://api.localxpose.io/api/v2/downloads/loclx-windows-amd64.zip -OutFile loclx.zip
          Expand-Archive loclx.zip -DestinationPath .

      - name: Setup RDP
        run: |
          net user kame23 S5316875844@a /add
          net localgroup administrators kame23 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-Service -Name "TermService" -StartupType Automatic
          Start-Service -Name "TermService"
          Start-Sleep -Seconds 10

      - name: Start LocalXpose Tunnel
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          # Login with token
          .\loclx.exe account login --token $env:LOCLX_TOKEN
          
          # Start tunnel
          Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel", "tcp", "--to", "localhost:3389" -NoNewWindow -RedirectStandardOutput tunnel.log
          
          Start-Sleep -Seconds 20
          
          Get-Content tunnel.log
          
          Write-Host "=========================================="
          Write-Host "Connection info above"
          Write-Host "Username: kame23 | Password: S5316875844@a"
          Write-Host "=========================================="

      - name: Keep alive
        run: |
          while ($true) {
            Start-Sleep -Seconds 300
            Write-Host "Active: $(Get-Date)"
          }
